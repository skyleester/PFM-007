# ë‚´ë¶€ ì´ì²´ ë§¤ì¹­ v2 êµ¬í˜„ ì™„ë£Œ (2025-10-20)

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. ì‹ ë¢°ë„ ì ìˆ˜ ì‹œìŠ¤í…œ êµ¬í˜„
- **íŒŒì¼**: `apps/web/lib/importers/banksalad.ts`
- **í•¨ìˆ˜**: 
  - `calculateSimilarity()`: Levenshtein distance ê¸°ë°˜ ë¬¸ìì—´ ìœ ì‚¬ë„ (0.0~1.0)
  - `calculateMatchConfidence()`: ë‚´ë¶€ ì´ì²´ ë§¤ì¹­ ì‹ ë¢°ë„ ê³„ì‚° (0~100ì )
- **ì ìˆ˜ ì²´ê³„**:
  - ì‹œê°„+ê¸ˆì•¡ ì¼ì¹˜: +50ì  (í•„ìˆ˜)
  - ë¶„ë¥˜ëª… "ì´ì²´" ê³„ì—´: +30ì 
  - "ë‚´ê³„ì¢Œì´ì²´" ëª…ì‹œ: +10ì  (ë³´ë„ˆìŠ¤)
  - ì„œë¡œ ë‹¤ë¥¸ ê³„ì¢Œ: +10ì 
  - Memo ìœ ì‚¬ë„ 70% ì´ìƒ: +10ì 
  - Memo ìœ ì‚¬ë„ 30% ë¯¸ë§Œ: -10ì  (íŒ¨ë„í‹°)
  - ë™ì¼ ê³„ì¢Œ (Aâ†’A): -20ì  (íŒ¨ë„í‹°)

### 2. 3ë‹¨ê³„ ë§¤ì¹­ ì‹œìŠ¤í…œ
- **CERTAIN** (80ì +): ìë™ìœ¼ë¡œ TRANSFER ìƒì„±
- **SUSPECTED** (50-79ì ): ì‚¬ìš©ì í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
- **UNLIKELY** (50ì  ë¯¸ë§Œ): ì™¸ë¶€ ì´ì²´ë¡œ INCOME/EXPENSE ë³€í™˜

### 3. í”„ë¡ íŠ¸ì—”ë“œ UI
- **íŒŒì¼**: `apps/web/app/transactions/page.tsx`
- **ê¸°ëŠ¥**:
  - ì˜ì‹¬ ë§¤ì¹­ ìë™ ê°ì§€ ì‹œ ëª¨ë‹¬ í‘œì‹œ
  - ê° ìŒë§ˆë‹¤ ì‹ ë¢°ë„ ì ìˆ˜/ì´ìœ  í‘œì‹œ
  - ì¶œê¸ˆ/ì…ê¸ˆ ìƒì„¸ ë¹„êµ
  - "ë‚´ë¶€ ì´ì²´ë¡œ ì—°ê²°" / "ë³„ë„ ê±°ë˜ë¡œ ë“±ë¡" ì„ íƒ
  - "ì „ì²´ ì—°ê²°" / "ì „ì²´ ë³„ë„ ë“±ë¡" ì¼ê´„ ì²˜ë¦¬
  - ëª¨ë“  í•­ëª© ê²°ì • í›„ ì—…ë¡œë“œ ì§„í–‰

### 4. ë°±ì—”ë“œ DB ë§¤ì¹­ ì¤€ë¹„
- **íŒŒì¼**: `apps/backend/app/routers.py`
- **í•¨ìˆ˜**: `find_potential_transfer_matches()`
- **ê¸°ëŠ¥**:
  - ê¸°ì¡´ DB íŠ¸ëœì­ì…˜ê³¼ ì‹œê°„+ê¸ˆì•¡ ë§¤ì¹­ (Â±5ë¶„ tolerance)
  - ë°˜ëŒ€ ë¶€í˜¸ ê¸ˆì•¡ ê²€ìƒ‰ (ì¶œê¸ˆ â†” ì…ê¸ˆ)
  - TRANSFER ì œì™¸ (ì´ë¯¸ ì—°ê²°ëœ ë‚´ë¶€ ì´ì²´)
  - ë™ì¼ ê³„ì¢Œ ì œì™¸
  - ì‹ ë¢°ë„ ê°„ë‹¨ ê³„ì‚° (50ì  ê¸°ë³¸ + memo/ì¹´í…Œê³ ë¦¬ íŒíŠ¸)
  - **í–¥í›„**: bulk APIì— í†µí•©í•˜ì—¬ ë¶„ì‚° ì—…ë¡œë“œ ë§¤ì¹­ ì§€ì›

### 5. í…ŒìŠ¤íŠ¸ ë° ë¬¸ì„œí™”
- **íŒŒì¼**: `test_transfer_matching.py`
- **ê²°ê³¼**:
  - Test Case 1 (ë¶„ë¥˜ëª… "ì´ì²´"): **80ì  CERTAIN** âœ…
  - Test Case 2 ("ë‚´ê³„ì¢Œì´ì²´" ëª…ì‹œ): **90ì  CERTAIN** âœ…
- **ë¬¸ì„œ**:
  - `.github/transfer-matching-v2.md`: ê¸°ìˆ  ì„¤ê³„ ë¬¸ì„œ
  - `.github/transfer-matching-user-guide.md`: ì‚¬ìš©ì ê°€ì´ë“œ

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼

### Test Case 1: í™•ì‹¤í•œ ë‚´ë¶€ ì´ì²´
```
ì¶œê¸ˆ: 2025-10-13 09:02  -400,000  ê¸‰ì—¬ í•˜ë‚˜ í†µì¥ (í˜¸ì²œ)
      ë¶„ë¥˜: ì´ì²´ > ë¯¸ë¶„ë¥˜
      ë©”ëª¨: ìœ¤ì§€ìˆ˜

ì…ê¸ˆ: 2025-10-13 09:02  +400,000  ì…ì¶œê¸ˆí†µì¥ 4305
      ë¶„ë¥˜: ì´ì²´ > ë¯¸ë¶„ë¥˜
      ë©”ëª¨: ì´í˜¸ì²œ

ì‹ ë¢°ë„: 80ì  (CERTAIN)
ì´ìœ : ì‹œê°„+ê¸ˆì•¡ ì¼ì¹˜, ë¶„ë¥˜ëª…ì´ ë‚´ë¶€ ì´ì²´ íŒ¨í„´ê³¼ ì¼ì¹˜, ì„œë¡œ ë‹¤ë¥¸ ê³„ì¢Œ, âš ï¸ ë‚´ìš© ë¶ˆì¼ì¹˜ (0%)

âœ… ê²°ê³¼: ìë™ìœ¼ë¡œ TRANSFER ìƒì„±
```

### Test Case 2: "ë‚´ê³„ì¢Œì´ì²´" ëª…ì‹œ
```
ì¶œê¸ˆ: 2025-10-10 09:45  -400,000  ê¸‰ì—¬ í•˜ë‚˜ í†µì¥(ì§€ìˆ˜)
      ë¶„ë¥˜: ë‚´ê³„ì¢Œì´ì²´ > ë¯¸ë¶„ë¥˜
      ë©”ëª¨: í˜¸í˜¸

ì…ê¸ˆ: 2025-10-10 09:45  +400,000  ì…ì¶œê¸ˆí†µì¥ 4305
      ë¶„ë¥˜: ë‚´ê³„ì¢Œì´ì²´ > ë¯¸ë¶„ë¥˜
      ë©”ëª¨: ìœ¤ì§€ìˆ˜

ì‹ ë¢°ë„: 90ì  (CERTAIN)
ì´ìœ : ì‹œê°„+ê¸ˆì•¡ ì¼ì¹˜, ë¶„ë¥˜ëª…ì´ ë‚´ë¶€ ì´ì²´ íŒ¨í„´ê³¼ ì¼ì¹˜, 'ë‚´ê³„ì¢Œì´ì²´' ëª…ì‹œ, ì„œë¡œ ë‹¤ë¥¸ ê³„ì¢Œ, âš ï¸ ë‚´ìš© ë¶ˆì¼ì¹˜ (0%)

âœ… ê²°ê³¼: ìë™ìœ¼ë¡œ TRANSFER ìƒì„±
```

---

## ğŸ¯ ë‹¬ì„±ëœ ëª©í‘œ

### ì‚¬ìš©ì ìš”êµ¬ì‚¬í•­
1. âœ… **ë¶„ë¥˜ëª…ì´ ë‹¤ë¥¸ ë‚´ë¶€ ì´ì²´** â†’ ìë™ ë§¤ì¹­ (80ì )
2. âœ… **ë‚´ìš©ì´ ë‹¤ë¥¸ ë‚´ë¶€ ì´ì²´** â†’ ìë™ ë§¤ì¹­ (90ì ) ë˜ëŠ” ì‚¬ìš©ì í™•ì¸ (ì„ê³„ê°’ ì¡°ì • ì‹œ)
3. âœ… **ì˜ì‹¬ ë§¤ì¹­ í™•ì¸ UI** â†’ ëª¨ë‹¬ë¡œ ì„ íƒ ê°€ëŠ¥
4. â³ **ë¶„ì‚° ì—…ë¡œë“œ ë§¤ì¹­** â†’ ë°±ì—”ë“œ í•¨ìˆ˜ ì¤€ë¹„ ì™„ë£Œ (API í†µí•© ëŒ€ê¸°)

### ê¸°ìˆ  ëª©í‘œ
- âœ… Levenshtein distance ê¸°ë°˜ memo ìœ ì‚¬ë„ ê³„ì‚°
- âœ… ì‹ ë¢°ë„ ì ìˆ˜ ì‹œìŠ¤í…œ (0-100ì , 3ë‹¨ê³„ ë¶„ë¥˜)
- âœ… í”„ë¡ íŠ¸ì—”ë“œ suspectedPairs ì²˜ë¦¬
- âœ… ë°±ì—”ë“œ DB ë§¤ì¹­ ë¡œì§

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„ (ì„ íƒ)

### 1. ì„ê³„ê°’ ë¯¸ì„¸ ì¡°ì •
í˜„ì¬ Test Case 2ê°€ 90ì ìœ¼ë¡œ ìë™ ì²˜ë¦¬ë˜ëŠ”ë°, ì‚¬ìš©ìê°€ "ì˜ì‹¬ ë§¤ì¹­"ìœ¼ë¡œ ë³´ê³  ì‹¶ë‹¤ë©´:

```typescript
// banksalad.tsì˜ calculateMatchConfidence í•¨ìˆ˜
if (score >= 90) {  // 80 â†’ 90ìœ¼ë¡œ ìƒí–¥
  level = "CERTAIN";
} else if (score >= 60) {  // 50 â†’ 60ìœ¼ë¡œ ìƒí–¥
  level = "SUSPECTED";
}
```

**íš¨ê³¼**:
- 90ì  ì´ìƒë§Œ ìë™ ì²˜ë¦¬
- 80-89ì ì€ ì‚¬ìš©ì í™•ì¸ â†’ Test Case 2 ëª¨ë‹¬ í‘œì‹œ

### 2. ë¶„ì‚° ì—…ë¡œë“œ ë§¤ì¹­ í™œì„±í™”
ë°±ì—”ë“œ bulk APIë¥¼ ìˆ˜ì •í•˜ì—¬ `find_potential_transfer_matches()` í†µí•©:

```python
# routers.pyì˜ bulk_upsert_transactions í•¨ìˆ˜
potential_matches = find_potential_transfer_matches(db, normalized, payload.user_id)
# ë°˜í™˜ê°’ì— í¬í•¨í•˜ì—¬ í”„ë¡ íŠ¸ì—”ë“œë¡œ ì „ë‹¬
```

í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê¸°ì¡´ íŠ¸ëœì­ì…˜ê³¼ì˜ ë§¤ì¹­ë„ suspectedPairsì— ì¶”ê°€:
```typescript
// transactions/page.tsx
if (response.potential_matches?.length > 0) {
  // suspectedPairsì— ë³‘í•©
}
```

### 3. ì‚¬ìš©ì ì„¤ì • ì˜µì…˜
```typescript
// ì‚¬ìš©ìë³„ ë§¤ì¹­ ì •ì±… ì„¤ì •
{
  "auto_link_internal_transfer_keywords": ["ë‚´ê³„ì¢Œì´ì²´"],
  "confidence_threshold_certain": 80,  // ì¡°ì • ê°€ëŠ¥
  "confidence_threshold_suspected": 50,
  "always_confirm_memo_mismatch": false,
}
```

---

## ğŸ“‚ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡

### í”„ë¡ íŠ¸ì—”ë“œ
1. `apps/web/lib/importers/banksalad.ts`
   - `calculateSimilarity()` ì¶”ê°€
   - `calculateMatchConfidence()` ì¶”ê°€
   - í˜ì–´ë§ ë¡œì§ì— ì‹ ë¢°ë„ ê³„ì‚° í†µí•©
   - `suspectedPairs` ë°˜í™˜

2. `apps/web/app/transactions/page.tsx`
   - `showSuspectedModal` ìƒíƒœ ì¶”ê°€
   - `suspectedPairDecisions` ìƒíƒœ ì¶”ê°€
   - `handleUpload()` ìˆ˜ì • (ì˜ì‹¬ ë§¤ì¹­ ì²˜ë¦¬)
   - ì˜ì‹¬ ë§¤ì¹­ í™•ì¸ ëª¨ë‹¬ UI ì¶”ê°€

### ë°±ì—”ë“œ
3. `apps/backend/app/routers.py`
   - `find_potential_transfer_matches()` ì¶”ê°€
   - ê¸°ì¡´ íŠ¸ëœì­ì…˜ ë§¤ì¹­ ë¡œì§ êµ¬í˜„

### í…ŒìŠ¤íŠ¸ & ë¬¸ì„œ
4. `test_transfer_matching.py` (ìƒˆ íŒŒì¼)
   - ì‹ ë¢°ë„ ê³„ì‚° í…ŒìŠ¤íŠ¸
   - 2ê°€ì§€ ì¼€ì´ìŠ¤ ê²€ì¦

5. `.github/transfer-matching-v2.md` (ìƒˆ íŒŒì¼)
   - ê¸°ìˆ  ì„¤ê³„ ë¬¸ì„œ
   - ì‹ ë¢°ë„ ì ìˆ˜ ì²´ê³„
   - API ì„¤ê³„
   - í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

6. `.github/transfer-matching-user-guide.md` (ìƒˆ íŒŒì¼)
   - ì‚¬ìš©ì ê°€ì´ë“œ
   - ì‚¬ìš© ë°©ë²•
   - FAQ
   - ì˜ˆì‹œ ì¼€ì´ìŠ¤

---

## ğŸ‰ ìš”ì•½

**êµ¬í˜„ ì™„ë£Œ ì‚¬í•­**:
1. âœ… ì‹ ë¢°ë„ ì ìˆ˜ ì‹œìŠ¤í…œ (0-100ì , 3ë‹¨ê³„)
2. âœ… ìë™/ìˆ˜ë™ ë§¤ì¹­ ë¶„ë¥˜ (CERTAIN/SUSPECTED/UNLIKELY)
3. âœ… í”„ë¡ íŠ¸ì—”ë“œ ì˜ì‹¬ ë§¤ì¹­ í™•ì¸ UI
4. âœ… ë°±ì—”ë“œ DB ë§¤ì¹­ ì¤€ë¹„
5. âœ… í…ŒìŠ¤íŠ¸ ê²€ì¦ (2ì¼€ì´ìŠ¤ PASS)
6. âœ… ì‚¬ìš©ì/ê¸°ìˆ  ë¬¸ì„œ ì‘ì„±

**í…ŒìŠ¤íŠ¸ ê²°ê³¼**:
- Test Case 1: 80ì  CERTAIN âœ…
- Test Case 2: 90ì  CERTAIN âœ…
- Lint: PASS âœ…
- Backend compile: PASS âœ…

**ì‚¬ìš©ì ê²½í—˜**:
- í™•ì‹¤í•œ ë‚´ë¶€ ì´ì²´: ìë™ ì²˜ë¦¬ (ëª¨ë‹¬ ì—†ìŒ)
- ì˜ì‹¬ ë‚´ë¶€ ì´ì²´: í™•ì¸ ëª¨ë‹¬ í‘œì‹œ (ì„ íƒ ê°€ëŠ¥)
- ì™¸ë¶€ ì´ì²´: ìë™ìœ¼ë¡œ INCOME/EXPENSE ë³€í™˜

**ë‹¤ìŒ ë‹¨ê³„** (ì„ íƒ):
- ì„ê³„ê°’ ë¯¸ì„¸ ì¡°ì • (ë” ë§ì€ í•­ëª©ì„ í™•ì¸ ëª¨ë‹¬ë¡œ)
- ë¶„ì‚° ì—…ë¡œë“œ ë§¤ì¹­ í™œì„±í™”
- ì‚¬ìš©ìë³„ ì„¤ì • ì˜µì…˜

ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸš€
