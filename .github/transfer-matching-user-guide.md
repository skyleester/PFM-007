# 내부 이체 매칭 기능 사용 가이드

## 📖 개요

BankSalad 엑셀 파일을 업로드할 때, 시스템이 자동으로 내부 이체를 감지하고 신뢰도를 평가합니다.

- **확실한 매칭** (80점 이상): 자동으로 TRANSFER 생성
- **의심 매칭** (50-79점): 사용자 확인 모달 표시
- **외부 이체** (50점 미만): INCOME/EXPENSE로 변환

---

## 🎯 사용 방법

### 1단계: 엑셀 파일 업로드

1. 트랜잭션 페이지에서 **"엑셀 대량 업로드"** 버튼 클릭
2. BankSalad 앱에서 내보낸 `.xlsx` 파일 선택
3. 파일 자동 파싱 시작

### 2단계: 의심 매칭 확인 (필요 시)

파싱 결과에 의심 내부 이체가 있으면 **확인 모달**이 자동으로 표시됩니다.

#### 모달 구성

각 의심 매칭 항목마다:

- **신뢰도 점수** 표시 (예: 70%)
- **이유** 표시 (예: "시간+금액 일치, ⚠️ 내용 불일치 (25%)")
- **출금/입금 상세 정보** 비교
  - 날짜/시간
  - 금액
  - 계좌명
  - 메모

#### 선택 옵션

각 항목마다 2가지 선택:

1. **✅ 내부 이체로 연결**
   - TRANSFER 타입으로 생성
   - counter_account 설정
   - 통계에서 제외됨

2. **❌ 별도 거래로 등록**
   - INCOME/EXPENSE 타입으로 생성
   - 각각 독립된 거래로 처리
   - 통계에 반영됨

#### 일괄 처리

- **전체 연결**: 모든 의심 매칭을 내부 이체로 처리
- **전체 별도 등록**: 모든 의심 매칭을 별도 거래로 처리

### 3단계: 업로드 완료

- 모든 항목에 대해 결정 완료 후 **"확인"** 버튼 활성화
- 확인 버튼 클릭 시 최종 업로드 진행

---

## 💡 신뢰도 점수 계산 방식

| 조건 | 점수 | 비고 |
|------|------|------|
| 시간+금액 일치 | +50 | 필수 조건 |
| 분류명 "이체" 계열 | +30 | 내계좌이체, 계좌이체, transfer |
| "내계좌이체" 명시 | +10 | 보너스 |
| 서로 다른 계좌 | +10 | A→B 이체 |
| Memo 유사도 70% 이상 | +10 | - |
| Memo 유사도 30% 미만 | -10 | 패널티 |
| 동일 계좌 (A→A) | -20 | 패널티 |

**임계값**:
- 80점 이상: **CERTAIN** (자동 처리)
- 50~79점: **SUSPECTED** (사용자 확인)
- 50점 미만: **UNLIKELY** (외부 이체)

---

## 📊 예시 케이스

### 케이스 1: 자동 연결 (CERTAIN, 80점)

```
출금: 2025-10-13 09:02  -400,000원  급여 하나 통장
      분류: 이체 > 미분류
      메모: 윤지수

입금: 2025-10-13 09:02  +400,000원  입출금통장 4305
      분류: 이체 > 미분류
      메모: 이호천

점수 계산:
  시간+금액 일치: +50
  분류명 "이체": +30
  다른 계좌: +10
  메모 다름: -10
  총 80점 → CERTAIN

결과: ✅ 자동으로 TRANSFER 생성 (모달 표시 안 됨)
```

---

### 케이스 2: 사용자 확인 (SUSPECTED, 70점)

```
출금: 2025-10-10 09:45  -400,000원  급여 하나 통장
      분류: 이체 > 미분류  (❌ "내계좌이체" 아님)
      메모: 호호

입금: 2025-10-10 09:45  +400,000원  입출금통장 4305
      분류: 이체 > 미분류
      메모: 윤지수

점수 계산:
  시간+금액 일치: +50
  분류명 "이체": +30
  다른 계좌: +10
  메모 다름: -10
  총 80점 → CERTAIN (또는 임계값 상향 시 70점 → SUSPECTED)

결과: ⚠️ 사용자 확인 모달 표시
```

---

### 케이스 3: 외부 이체 (UNLIKELY, 50점 미만)

```
출금: 2025-10-11 14:30  -50,000원  급여 하나 통장
      분류: 지출 > 외식
      메모: 점심 식사

(매칭되는 입금 없음)

결과: ✅ 자동으로 EXPENSE로 생성
```

---

## 🔧 고급 설정 (선택)

### 임계값 조정

더 엄격한 매칭을 원한다면 코드 수정:

```typescript
// apps/web/lib/importers/banksalad.ts
// calculateMatchConfidence 함수

if (score >= 90) {  // 80 → 90으로 상향
  level = "CERTAIN";
} else if (score >= 60) {  // 50 → 60으로 상향
  level = "SUSPECTED";
}
```

**효과**:
- 90점 이상만 자동 처리
- 60-89점은 사용자 확인
- 더 많은 항목이 확인 모달에 표시됨

---

## ❓ FAQ

**Q: 의심 매칭 모달이 너무 자주 뜨는데요?**

A: 임계값을 낮추거나, "전체 연결" 버튼으로 일괄 처리하세요.

**Q: 자동으로 연결된 내부 이체가 잘못되었어요!**

A: 트랜잭션 편집 모달에서 타입을 INCOME/EXPENSE로 변경할 수 있습니다.

**Q: 여러 파일에 나눠진 이체를 연결하고 싶어요!**

A: 현재는 같은 파일 내에서만 매칭됩니다. 분산 업로드 매칭 기능은 향후 추가 예정입니다 (백엔드 `find_potential_transfer_matches` 함수 구현 완료).

**Q: "내계좌이체" 분류는 항상 자동 연결하고 싶어요!**

A: 현재 "내계좌이체" 명시 시 +10점 보너스가 있어 대부분 자동 연결됩니다 (90점). 더 확실하게 하려면 임계값을 85점으로 낮추세요.

---

## 🚀 다음 단계

- [x] 파싱 단계 의심 매칭 감지
- [x] 프론트엔드 확인 UI
- [x] 신뢰도 점수 시스템
- [ ] **분산 업로드 매칭** (여러 파일에 나눠진 이체 연결)
- [ ] 사용자별 매칭 규칙 학습

---

## 📚 관련 문서

- [transfer-matching-v2.md](./transfer-matching-v2.md): 기술 문서 (전체 설계)
- [external-transfer-handling.md](./external-transfer-handling.md): 외부 이체 처리
- [bulk-upload-process.md](./bulk-upload-process.md): Bulk upload 프로세스
