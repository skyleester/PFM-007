"use client";

export default function CalendarPage() {
  return (
    <div className="p-6 text-sm text-gray-600">calendar/page.tsx temporarily disabled; will be restored after build fix.</div>
  );
  /*
      if (typeof focusTxnId === "number") {
        params.set("focusTxn", String(focusTxnId));
      }
      router.push(`/transactions?${params.toString()}`);
    },
    [router]
  );

  const handleViewTransactions = useCallback(
    (date: Date) => {
      navigateToTransactions(date);
    },
    [navigateToTransactions]
  );

  const handleInspectTransaction = useCallback(
    (txn: CalendarTransaction, date: Date) => {
      if (typeof window !== "undefined") {
        const confirmed = window.confirm("í•´ë‹¹ ê±°ë˜ í¸ì§‘ í™”ë©´ìœ¼ë¡œ ì´ë™í• ê¹Œìš”? ê¸°ì¡´ ì‘ì—…ì€ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        if (!confirmed) {
          return;
        }
      }
      navigateToTransactions(date, txn.id);
    },
    [navigateToTransactions]
  );

  useEffect(() => {
    resetEventForm();
    setEventMessage(null);
  }, [resetEventForm]);

  const updateEventDraft = useCallback((patch: Partial<EventFormState>) => {
    setEventDraft((prev) => ({ ...prev, ...patch }));
  }, []);

  const editingEventId = eventMode === "edit" ? eventDraft.id ?? null : null;

  const handleEditEvent = useCallback((event: CalendarEvent) => {
    setEventMode("edit");
    setEventDraft({
      id: event.id,
      date: event.date,
      type: event.type,
      title: event.title,
      description: event.description ?? "",
      color: event.color ?? "",
    });
    setEventError(null);
    setEventMessage(null);
  }, []);

  const handleDeleteEvent = useCallback(
    async (event: CalendarEvent) => {
      if (typeof window !== "undefined") {
        const confirmed = window.confirm(`'${event.title}' ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?`);
        if (!confirmed) return;
      }
      try {
        setEventDeletingId(event.id);
        setEventError(null);
        setEventMessage(null);
        const activeUserId = (memberIds && memberIds.length > 0) ? memberIds[0] : USER_ID;
        await deleteCalendarEvent(activeUserId, event.id);
        if (editingEventId === event.id) {
          resetEventForm();
        }
        setEventMessage("ë©”ëª¨ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
        refresh();
      } catch (err) {
        setEventError(err instanceof Error ? err.message : String(err));
      } finally {
        setEventDeletingId(null);
      }
    },
    [editingEventId, refresh, resetEventForm, memberIds]
  );

  const handleEventSubmit = useCallback(async () => {
    if (!eventDraft.title.trim()) {
      setEventError("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    const trimmedDescription = eventDraft.description.trim();
    const trimmedColor = eventDraft.color.trim();
    const sanitizedColor = trimmedColor ? trimmedColor.toLowerCase() : null;
    setEventSubmitting(true);
    setEventError(null);
    setEventMessage(null);
    try {
      const activeUserId = (memberIds && memberIds.length > 0) ? memberIds[0] : USER_ID;
      if (eventMode === "edit" && eventDraft.id) {
        await updateCalendarEvent({
          id: eventDraft.id,
          userId: activeUserId,
          date: eventDraft.date,
          type: eventDraft.type,
          title: eventDraft.title.trim(),
          description: trimmedDescription ? trimmedDescription : null,
          color: sanitizedColor,
        });
        setEventMessage("ë©”ëª¨ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.");
      } else {
        await createCalendarEvent({
          userId: activeUserId,
          date: eventDraft.date,
          type: eventDraft.type,
          title: eventDraft.title.trim(),
          description: trimmedDescription ? trimmedDescription : null,
          color: sanitizedColor,
        });
        setEventMessage("ë©”ëª¨ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.");
      }
      refresh();
      resetEventForm();
    } catch (err) {
      setEventError(err instanceof Error ? err.message : String(err));
    } finally {
      setEventSubmitting(false);
    }
  }, [eventDraft, eventMode, refresh, resetEventForm, memberIds]);

  useEffect(() => {
    setSelectedDate(cursor);
  }, [cursor, setSelectedDate]);

  const filtersActive = filters.accounts.length > 0 || filters.categories.length > 0;

  const toggleAccountFilter = (id: number) => {
    setFilters((prev) => {
      const exists = prev.accounts.includes(id);
      const accounts = exists ? prev.accounts.filter((value) => value !== id) : [...prev.accounts, id];
      return { ...prev, accounts };
    });
  };

  const toggleCategoryFilter = (id: number) => {
    setFilters((prev) => {
      const exists = prev.categories.includes(id);
      const categories = exists ? prev.categories.filter((value) => value !== id) : [...prev.categories, id];
      return { ...prev, categories };
    });
  };

  const resetFilters = () => {
    setFilters({ accounts: [], categories: [] });
  };

  const changeView = (next: CalendarView) => {
    setView(next);
    if (next === "week" || next === "day") {
      setCursor(new Date(selectedDate));
    }
  };

  const handleSelectDate = (value: Date) => {
    setSelectedDate(value);
    setCursor(new Date(value));
  };

  const title = useMemo(() => {
    if (view === "month") return format(cursor, "yyyyë…„ MMì›”");
    if (view === "week") {
      const weekStart = startOfWeek(cursor, { weekStartsOn: 0 });
      const weekEnd = endOfWeek(cursor, { weekStartsOn: 0 });
      return `${format(weekStart, "yyyy.MM.dd")} ~ ${format(weekEnd, "MM.dd")}`;
    }
    return format(cursor, "yyyyë…„ MMì›” ddì¼");
  }, [view, cursor]);

  const goToday = () => setCursor(new Date());
  const goPrev = () => {
    setCursor((prev) => {
      if (view === "month") return subMonths(prev, 1);
      if (view === "week") return subWeeks(prev, 1);
      return addDays(prev, -1);
    });
  };
  const goNext = () => {
    setCursor((prev) => {
      if (view === "month") return addMonths(prev, 1);
      if (view === "week") return addWeeks(prev, 1);
      return addDays(prev, 1);
    });
  };

  const headerActions = (
    <div className="flex flex-wrap items-center gap-2">
      <MemberSelector value={memberIds} onChange={setMemberIds} />
      <div className="inline-flex rounded border bg-white text-sm shadow-sm">
        {(["month", "week", "day"] as CalendarView[]).map((item) => (
          <button
            key={item}
            type="button"
            onClick={() => changeView(item)}
            className={`px-3 py-1 capitalize ${view === item ? "bg-gray-900 text-white" : "text-gray-600 hover:bg-gray-100"}`}
          >
            {item}
          </button>
        ))}
      </div>
    </div>
  );

  return (
    <div className="space-y-8">
      <PageHeader
        title="Calendar"
        subtitle="ê±°ë˜ì™€ ì •ê¸° ê·œì¹™ì„ ë‹¬ë ¥ í˜•íƒœë¡œ íƒìƒ‰í•©ë‹ˆë‹¤."
        actions={headerActions}
      />

      {status === "loading" && (
        <SectionCard tone="muted">
          <p className="text-sm text-gray-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>
        </SectionCard>
      )}
      {status === "error" && (
        <SectionCard tone="muted">
          <p className="text-sm text-red-600">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: {error?.message}</p>
        </SectionCard>
      )}
      {status === "success" && activeSnapshot && (
        <>
          <SectionCard title="ê¸°ê°„ ìš”ì•½" description="ì„ íƒëœ ê¸°ê°„ì˜ ë°ì´í„° í†µê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”.">
            <div className="grid gap-3 sm:grid-cols-3">
              <div className="rounded border border-dashed border-gray-200 bg-gray-50 p-3 text-sm">
                <div className="text-xs text-gray-500">ê¸°ê°„</div>
                <div className="mt-1 font-medium text-gray-800">
                  {activeSnapshot.range.start} ~ {activeSnapshot.range.end}
                </div>
              </div>
              <div className="rounded border border-dashed border-gray-200 bg-gray-50 p-3 text-sm">
                <div className="text-xs text-gray-500">íŠ¸ëœì­ì…˜</div>
                <div className="mt-1 font-medium text-gray-800">{activeSnapshot.transactions.length.toLocaleString()}ê±´</div>
              </div>
              <div className="rounded border border-dashed border-gray-200 bg-gray-50 p-3 text-sm">
                <div className="text-xs text-gray-500">ì •ê¸° ê·œì¹™ ì¼ì •</div>
                <div className="mt-1 font-medium text-gray-800">{activeSnapshot.recurringOccurrences.length.toLocaleString()}ê±´</div>
              </div>
            </div>
          </SectionCard>

          <div className="space-y-6 lg:grid lg:grid-cols-[minmax(0,2.5fr)_minmax(360px,1fr)] lg:items-start lg:gap-6 lg:space-y-0">
            <div className="space-y-6">
              {filtersActive && (
                <SectionCard tone="brand">
                  <p className="text-sm text-indigo-700">
                    í•„í„° ì ìš© ì¤‘ â€” {activeSnapshot.transactions.length.toLocaleString()}ê±´ì˜ ê±°ë˜ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                  </p>
                </SectionCard>
              )}

              <SectionCard>
                {view === "month" && (
                  <MonthGrid grid={monthGrid} referenceDate={cursor} selectedKey={selectedKey} onSelectDate={handleSelectDate} />
                )}
                {view === "week" && (
                  <WeekView
                    days={weekBuckets}
                    selectedKey={selectedKey}
                    onSelectDate={handleSelectDate}
                  />
                )}
                {view === "day" && selectedBucket && (
                  <DayOverview bucket={selectedBucket} date={selectedDate} />
                )}
              </SectionCard>
            </div>

            <StickyAside
              className="static lg:sticky overflow-visible border-transparent bg-transparent p-0 shadow-none"
              offset={104}
            >
              <div className="space-y-4">
                <FilterControls
                  accounts={accountChoices}
                  categories={categoryChoices}
                  filters={filters}
                  onToggleAccount={toggleAccountFilter}
                  onToggleCategory={toggleCategoryFilter}
                  onClear={resetFilters}
                  status={metaStatus}
                  error={metaError}
                />
                {selectedBucket ? (
                  <DayDetail
                    bucket={selectedBucket}
                    date={selectedDate}
                    variant="full"
                    onEditEvent={handleEditEvent}
                    onDeleteEvent={handleDeleteEvent}
                    editingEventId={editingEventId}
                    deletingEventId={eventDeletingId}
                    onViewTransactions={handleViewTransactions}
                    onInspectTransaction={(txn) => handleInspectTransaction(txn, selectedDate)}
                    memberColorMap={memberColorMap}
                    memberInitial={memberInitial}
                    baseSnapshot={baseSnapshot}
                  />
                ) : (
                  <SectionCard tone="muted">
                    <p className="text-sm text-gray-500 text-center">ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                  </SectionCard>
                )}
                <EventEditor
                  mode={eventMode}
                  draft={eventDraft}
                  onDraftChange={updateEventDraft}
                  onSubmit={handleEventSubmit}
                  submitting={eventSubmitting}
                  onCancel={resetEventForm}
                  error={eventError}
                  message={eventMessage}
                />
              </div>
            </StickyAside>
          </div>
        </>
      )}
    </div>
  );
}

function FilterControls({
  accounts,
  categories,
  filters,
  onToggleAccount,
  onToggleCategory,
  onClear,
  status,
  error,
}: {
  accounts: FilterOption[];
  categories: FilterOption[];
  filters: CalendarFilters;
  onToggleAccount: (id: number) => void;
  onToggleCategory: (id: number) => void;
  onClear: () => void;
  status: "idle" | "loading" | "success" | "error";
  error: string | null;
}) {
  const hasFilters = filters.accounts.length > 0 || filters.categories.length > 0;
  return (
    <SectionCard
      title="í•„í„°"
      description="ê³„ì¢Œì™€ ì¹´í…Œê³ ë¦¬ë¡œ í‘œì‹œí•  ê±°ë˜ë¥¼ ì„ íƒí•˜ì„¸ìš”."
      headerAction={
        <button
          type="button"
          onClick={onClear}
          disabled={!hasFilters}
          className={`rounded border px-2 py-1 text-xs ${hasFilters ? "border-indigo-300 text-indigo-600 hover:bg-indigo-100" : "border-gray-200 text-gray-400"}`}
        >
          ì´ˆê¸°í™”
        </button>
      }
    >
      {status === "loading" && <p className="text-xs text-gray-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>}
      {error && <p className="text-xs text-red-600">ë¡œë“œ ì‹¤íŒ¨: {error}</p>}
      <div className="grid gap-4 md:grid-cols-2">
        <FilterList label="ê³„ì¢Œ" items={accounts} selected={filters.accounts} onToggle={onToggleAccount} disabled={status === "loading" && accounts.length === 0} />
        <FilterList label="ì¹´í…Œê³ ë¦¬" items={categories} selected={filters.categories} onToggle={onToggleCategory} disabled={status === "loading" && categories.length === 0} />
      </div>
    </SectionCard>
  );
}

function FilterList({ label, items, selected, onToggle, disabled }: { label: string; items: FilterOption[]; selected: number[]; onToggle: (id: number) => void; disabled?: boolean }) {
  return (
    <div>
      <div className="text-xs uppercase tracking-wide text-gray-500">{label}</div>
      <div className="mt-2 max-h-48 space-y-1 overflow-y-auto rounded border border-gray-200 bg-white p-2">
        {items.length === 0 ? (
          <p className="text-[11px] text-gray-400">{disabled ? "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘" : "ì‚¬ìš© ê°€ëŠ¥í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤."}</p>
        ) : (
          items.map((item) => {
            const checked = selected.includes(item.id);
            return (
              <label key={item.id} className="flex cursor-pointer items-center gap-2 text-[11px] text-gray-600">
                <input
                  type="checkbox"
                  className="h-3 w-3 rounded border-gray-300"
                  checked={checked}
                  onChange={() => onToggle(item.id)}
                  disabled={disabled}
                />
                <span className={checked ? "font-semibold text-gray-900" : undefined}>{item.label}</span>
              </label>
            );
          })
        )}
      </div>
    </div>
  );
}

const weekdays = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];

function MonthGrid({ grid, referenceDate, selectedKey, onSelectDate }: { grid: CalendarDayBucket[][]; referenceDate: Date; selectedKey: string; onSelectDate: (date: Date) => void }) {
  return (
    <div className="space-y-1">
      <div className="grid grid-cols-7 gap-px text-center text-xs uppercase text-gray-500">
        {weekdays.map((weekday) => (
          <div key={weekday} className="py-2 font-semibold tracking-wide">{weekday}</div>
        ))}
      </div>
      <div className="grid grid-cols-7 gap-px rounded border border-gray-200 bg-gray-200">
        {grid.map((row, rowIndex) => (
          <Fragment key={rowIndex}>
            {row.map((bucket) => (
              <MonthCell key={`${bucket.date}-${rowIndex}`} bucket={bucket} referenceDate={referenceDate} selectedKey={selectedKey} onSelectDate={onSelectDate} />
            ))}
          </Fragment>
        ))}
      </div>
    </div>
  );
}

function MonthCell({ bucket, referenceDate, selectedKey, onSelectDate }: { bucket: CalendarDayBucket; referenceDate: Date; selectedKey: string; onSelectDate: (date: Date) => void }) {
  if (!bucket.date) {
    return <div className="h-32 bg-white" />;
  }
  const cellDate = new Date(bucket.date);
  const outsideCurrentMonth = !isSameMonth(cellDate, referenceDate);
  const today = isToday(cellDate);
  const hasHolidays = bucket.holidays.length > 0;
  const dayClass = outsideCurrentMonth
    ? "text-gray-300"
    : hasHolidays
      ? "text-rose-600"
      : today
        ? "text-indigo-600"
        : "text-gray-900";
  const totals = bucket.totals;
  const hasRecurring = bucket.recurring.length > 0;
  const hasEvents = bucket.events.length > 0;
  const hasTransactions = bucket.transactions.length > 0;
  const isSelected = bucket.date === selectedKey;
  return (
    <button
      type="button"
      onClick={() => onSelectDate(cellDate)}
      className={`flex h-32 flex-col justify-between bg-white p-2 text-left transition ${outsideCurrentMonth ? "opacity-70" : ""} ${isSelected ? "ring-2 ring-indigo-500" : "hover:bg-indigo-50"}`}
    >
      <div className="flex items-center justify-between text-xs">
        <span className={`font-semibold ${dayClass}`}>{format(cellDate, "d")}</span>
        {today && <span className="rounded-full bg-indigo-600 px-1.5 py-0.5 text-[10px] font-medium text-white">Today</span>}
      </div>
      {hasHolidays && (
        <div className="mt-1 space-y-0.5 text-[10px] font-semibold text-rose-500">
          {bucket.holidays.slice(0, 2).map((holiday) => (
            <div key={holiday.name}>{holiday.name}</div>
          ))}
          {bucket.holidays.length > 2 && <div className="text-[9px] font-normal text-rose-400">ì™¸ {bucket.holidays.length - 2}ê±´</div>}
        </div>
      )}
      <div className="space-y-1 text-[11px] leading-tight text-gray-600">
        {hasTransactions && (
          <div className="flex items-center justify-between">
            <span className="text-gray-500">ì§€ì¶œ</span>
            <span className="tabular-nums text-rose-600">{totals.expense.toLocaleString()}</span>
          </div>
        )}
        {hasTransactions && (
          <div className="flex items-center justify-between">
            <span className="text-gray-500">ìˆ˜ì…</span>
            <span className="tabular-nums text-emerald-600">{totals.income.toLocaleString()}</span>
          </div>
        )}
        {totals.transferIn !== 0 || totals.transferOut !== 0 ? (
          <div className="flex items-center justify-between text-[10px]">
            <span className="text-gray-400">Transfer</span>
            <span className="tabular-nums text-gray-500">+{totals.transferIn.toLocaleString()} / -{totals.transferOut.toLocaleString()}</span>
          </div>
        ) : null}
        {!hasTransactions && !hasRecurring && !hasEvents && (
          <p className="text-[10px] text-gray-300">ê¸°ë¡ ì—†ìŒ</p>
        )}
      </div>
      <div className="flex flex-wrap gap-1">
        {hasHolidays && (
          <span className="rounded-full bg-rose-50 px-2 py-0.5 text-[10px] font-medium text-rose-600">
            ê³µíœ´ì¼ {bucket.holidays.length}
          </span>
        )}
        {hasRecurring && (
          <span className="rounded-full bg-indigo-50 px-2 py-0.5 text-[10px] font-medium text-indigo-600">
            ì •ê¸° {bucket.recurring.length}
          </span>
        )}
        {hasEvents && (
          <span className="rounded-full bg-amber-50 px-2 py-0.5 text-[10px] font-medium text-amber-600">
            ë©”ëª¨ {bucket.events.length}
          </span>
        )}
      </div>
    </button>
  );
}

function WeekView({ days, selectedKey, onSelectDate }: { days: CalendarDayBucket[]; selectedKey: string; onSelectDate: (date: Date) => void }) {
  const totals = days.reduce(
    (acc, bucket) => {
      acc.income += bucket.totals.income;
      acc.expense += bucket.totals.expense;
      acc.net += bucket.totals.net;
      acc.transferIn += bucket.totals.transferIn;
      acc.transferOut += bucket.totals.transferOut;
      return acc;
    },
    { income: 0, expense: 0, net: 0, transferIn: 0, transferOut: 0 }
  );

  return (
    <div className="space-y-4">
      <div className="rounded border border-dashed border-gray-200 p-4 text-sm text-gray-600">
        <div className="text-xs uppercase text-gray-500">ì£¼ê°„ í•©ì‚°</div>
        <div className="mt-2 flex flex-wrap items-center gap-4 text-sm">
          <span className="flex items-center gap-1 text-gray-600"><strong className="text-gray-900">ìˆœìˆ˜ìµ</strong> {totals.net.toLocaleString()}</span>
          <span className="flex items-center gap-1 text-emerald-600"><strong>ìˆ˜ì…</strong> {totals.income.toLocaleString()}</span>
          <span className="flex items-center gap-1 text-rose-600"><strong>ì§€ì¶œ</strong> {totals.expense.toLocaleString()}</span>
          <span className="flex items-center gap-1 text-gray-500"><strong>ì´ì²´</strong> +{totals.transferIn.toLocaleString()} / -{totals.transferOut.toLocaleString()}</span>
        </div>
      </div>
      <div className="grid gap-2 sm:grid-cols-2 lg:grid-cols-7">
        {days.map((bucket) => {
          const dateObj = new Date(bucket.date);
          const label = format(dateObj, "MM/dd (EEE)");
          const isSelected = bucket.date === selectedKey;
          const hasRecurring = bucket.recurring.length > 0;
          const hasEvents = bucket.events.length > 0;
          const hasHolidays = bucket.holidays.length > 0;
          return (
            <button
              key={bucket.date}
              type="button"
              onClick={() => onSelectDate(dateObj)}
              className={`rounded border p-3 text-left text-sm transition ${isSelected ? "border-indigo-500 bg-indigo-50" : "border-gray-200 bg-white hover:border-indigo-200 hover:bg-indigo-50"}`}
            >
              <div className="flex items-center justify-between text-xs font-semibold text-gray-700">
                <span>{label}</span>
                {isToday(dateObj) && <span className="rounded-full bg-indigo-100 px-2 py-0.5 text-[10px] text-indigo-600">ì˜¤ëŠ˜</span>}
              </div>
              <div className="mt-2 space-y-1 text-[12px] text-gray-600">
                <div className="flex justify-between"><span>ì§€ì¶œ</span><span className="tabular-nums text-rose-600">{bucket.totals.expense.toLocaleString()}</span></div>
                <div className="flex justify-between"><span>ìˆ˜ì…</span><span className="tabular-nums text-emerald-600">{bucket.totals.income.toLocaleString()}</span></div>
                {(hasHolidays || hasRecurring || hasEvents) && (
                  <div className="flex flex-wrap gap-1 pt-1">
                    {hasHolidays && <span className="rounded-full bg-rose-50 px-2 py-0.5 text-[10px] font-medium text-rose-600">ê³µíœ´ì¼ {bucket.holidays.length}</span>}
                    {hasRecurring && <span className="rounded-full bg-indigo-50 px-2 py-0.5 text-[10px] font-medium text-indigo-600">ì •ê¸° {bucket.recurring.length}</span>}
                    {hasEvents && <span className="rounded-full bg-amber-50 px-2 py-0.5 text-[10px] font-medium text-amber-600">ë©”ëª¨ {bucket.events.length}</span>}
                  </div>
                )}
              </div>
            </button>
          );
        })}
      </div>
    </div>
  );
}

type DayDetailVariant = "full" | "condensed";

function DayOverview({ bucket, date }: { bucket: CalendarDayBucket; date: Date }) {
  const dateLabel = format(date, "yyyyë…„ MMì›” ddì¼ (EEE)");
  const { totals } = bucket;
  const stats = [
    { label: "ìˆ˜ì…", value: totals.income, tone: "text-emerald-600" },
    { label: "ì§€ì¶œ", value: totals.expense, tone: "text-rose-600" },
    { label: "ìˆœìˆ˜ìµ", value: totals.net, tone: "text-gray-900" },
    { label: "ì´ì²´ ìœ ì…", value: totals.transferIn, tone: "text-gray-600" },
    { label: "ì´ì²´ ìœ ì¶œ", value: totals.transferOut, tone: "text-gray-600" },
  ];
  return (
    <div className="rounded border border-dashed border-gray-200 bg-white p-4 shadow-sm">
      <div className="flex flex-wrap items-end justify-between gap-2 border-b border-dashed border-gray-200 pb-2">
        <div>
          <div className="text-xs uppercase text-gray-500">ì„ íƒëœ ë‚ ì§œ</div>
          <div className="text-base font-semibold text-gray-900">{dateLabel}</div>
        </div>
        <div className="text-xs text-gray-500">
          ê±°ë˜ {bucket.transactions.length.toLocaleString()}ê±´ Â· ì •ê¸° {bucket.recurring.length.toLocaleString()}ê±´ Â· ë©”ëª¨ {bucket.events.length.toLocaleString()}ê±´
          {bucket.holidays.length > 0 && <> Â· ê³µíœ´ì¼ {bucket.holidays.length.toLocaleString()}ê±´</>}
        </div>
      </div>
      <div className="mt-3 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
        {stats.map((item) => (
          <div key={item.label} className="rounded border border-gray-100 bg-gray-50 px-3 py-2">
            <div className="text-[11px] uppercase text-gray-400">{item.label}</div>
            <div className={`mt-1 text-sm font-semibold ${item.tone}`}>{item.value.toLocaleString()}</div>
          </div>
        ))}
      </div>
    </div>
  );
}

function DayDetail({
  bucket,
  date,
  variant,
  onEditEvent,
  onDeleteEvent,
  editingEventId,
  deletingEventId,
  onViewTransactions,
  onInspectTransaction,
  memberColorMap,
  memberInitial,
  baseSnapshot,
}: {
  bucket: CalendarDayBucket;
  date: Date;
  variant: DayDetailVariant;
  onEditEvent?: (event: CalendarEvent) => void;
  onDeleteEvent?: (event: CalendarEvent) => void;
  editingEventId?: number | null;
  deletingEventId?: number | null;
  onViewTransactions?: (date: Date) => void;
  onInspectTransaction?: (txn: CalendarTransaction) => void;
  memberColorMap: Map<number, string>;
  memberInitial: (id: number) => string;
  baseSnapshot?: CalendarSnapshot;
}) {
  const dateLabel = format(date, "yyyyë…„ MMì›” ddì¼ (EEE)");
  const transactions = [...bucket.transactions].sort((a, b) => new Date(a.occurred_at).getTime() - new Date(b.occurred_at).getTime());
  const recurring = bucket.recurring;
  const events = bucket.events;
  const holidays = bucket.holidays;
  const hasContent = transactions.length > 0 || recurring.length > 0 || events.length > 0 || holidays.length > 0;

  return (
    <SectionCard
      title={dateLabel}
      description="ì„ íƒëœ ë‚ ì§œì˜ ê±°ë˜, ì •ê¸° ì¼ì •, ë©”ëª¨ë¥¼ í™•ì¸í•˜ì„¸ìš”."
      headerAction={
        onViewTransactions ? (
          <button
            type="button"
            onClick={() => onViewTransactions(date)}
            className="rounded border border-indigo-200 px-2 py-1 text-xs text-indigo-600 transition hover:bg-indigo-50"
          >
            ìì„¸íˆë³´ê¸°
          </button>
        ) : undefined
      }
    >
      <div className="flex flex-wrap gap-3 text-xs text-gray-600">
        <span>ìˆ˜ì… <strong className="text-emerald-600">{bucket.totals.income.toLocaleString()}</strong></span>
        <span>ì§€ì¶œ <strong className="text-rose-600">{bucket.totals.expense.toLocaleString()}</strong></span>
        <span>ìˆœìˆ˜ìµ <strong className="text-gray-900">{bucket.totals.net.toLocaleString()}</strong></span>
      </div>
      {hasContent ? (
        <div className="space-y-4">
          <section>
            <h4 className="text-xs font-semibold uppercase text-gray-500">ê³µíœ´ì¼</h4>
            {holidays.length === 0 ? (
              <p className="mt-1 text-xs text-gray-400">ë“±ë¡ëœ ê³µíœ´ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            ) : (
              <ul className="mt-2 space-y-1">
                {holidays.map((holiday) => (
                  <li key={`holiday-${holiday.date}-${holiday.name}`} className="flex items-center justify-between rounded border border-rose-100 bg-rose-50 px-2 py-1 text-xs text-rose-700">
                    <span className="font-semibold">{holiday.name}</span>
                    <span className="text-[11px] uppercase text-rose-400">ê³µíœ´ì¼</span>
                  </li>
                ))}
              </ul>
            )}
          </section>
          <section>
            <h4 className="text-xs font-semibold uppercase text-gray-500">ê±°ë˜</h4>
            {transactions.length === 0 ? (
              <p className="mt-1 text-xs text-gray-400">ê¸°ë¡ëœ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            ) : (
              <ul className="mt-2 space-y-2">
                {transactions.map((txn) => {
                  const recurring = isRecurringTransaction(txn);
                  const tone = memberColorMap.get(txn.user_id) || "#4b5563";
                  const content = (
                    <div
                      className={clsx(
                        "flex w-full items-center justify-between rounded border px-2 py-1 text-xs transition",
                        recurring ? "border-indigo-200 bg-indigo-50 text-indigo-700" : "border-gray-200 bg-white",
                        onInspectTransaction ? "cursor-pointer hover:border-indigo-300 hover:bg-indigo-50" : null
                      )}
                    >
                      <div className="flex items-center gap-2">
                        <span className="inline-flex items-center gap-1 rounded-full px-1.5 py-0.5 text-[10px] font-medium" style={{ backgroundColor: `${tone}1A`, color: tone }}>
                          {memberInitial(txn.user_id)}
                        </span>
                        <span className={clsx("rounded px-1.5 py-0.5 font-medium", recurring ? "bg-indigo-100 text-indigo-700" : "bg-gray-100 text-gray-600")}>{formatTransactionTime(txn)}</span>
                        <span className={clsx("font-semibold", recurring ? "text-indigo-700" : "text-gray-700")}>{renderTxnTypeLabel(txn.type)}</span>
                        {recurring && (
                          <span className="inline-flex items-center gap-1 rounded-full bg-indigo-100 px-1.5 py-0.5 text-[10px] font-medium text-indigo-600">
                            ì •ê¸°
                          </span>
                        )}
                        {recurring && txn.recurring_rule_name && (
                          <span className="rounded bg-indigo-200/60 px-1.5 py-0.5 text-[10px] font-medium text-indigo-700">{txn.recurring_rule_name}</span>
                        )}
                        {txn.memo && <span className={recurring ? "text-indigo-600" : "text-gray-500"}>{txn.memo}</span>}
                      </div>
                      <span className={clsx("tabular-nums font-semibold", amountTone(txn))}>{formatTxnAmount(txn)}</span>
                    </div>
                  );
                  return (
                    <li key={`txn-${txn.id}`} className="group">
                      {onInspectTransaction ? (
                        <button
                          type="button"
                          onClick={() => onInspectTransaction(txn)}
                          className="w-full text-left focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400"
                        >
                          {content}
                        </button>
                      ) : (
                        content
                      )}
                    </li>
                  );
                })}
              </ul>
            )}
          </section>
          <section>
            <h4 className="text-xs font-semibold uppercase text-gray-500">ì •ê¸° ì¼ì •</h4>
            {recurring.length === 0 ? (
              <p className="mt-1 text-xs text-gray-400">ì˜ˆì •ëœ ì •ê¸° ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            ) : (
              <ul className="mt-2 space-y-2">
                {recurring.map((item) => {
                  const matchedUserId = baseSnapshot?.transactions.find((t: CalendarTransaction) => t.recurring_rule_id === item.ruleId)?.user_id ?? USER_ID;
                  const tone = memberColorMap.get(matchedUserId) || "#4b5563";
                  const amountValue = typeof item.amount === "number" ? item.amount : null;
                  const prefix = item.ruleType === "EXPENSE" ? "-" : item.ruleType === "INCOME" ? "+" : "Â±";
                  return (
                    <li
                      key={`recurring-${item.ruleId}`}
                      className="flex items-center justify-between rounded border px-2 py-1 text-xs"
                      style={{ borderColor: `${tone}40`, backgroundColor: `${tone}14`, color: tone }}
                    >
                      <div className="flex items-center gap-2">
                        <span className="inline-flex items-center gap-1 rounded-full px-1.5 py-0.5 text-[10px] font-medium" style={{ backgroundColor: `${tone}1A`, color: tone }}>{memberInitial(matchedUserId)}</span>
                        <span className="rounded bg-indigo-100 px-1.5 py-0.5 font-medium uppercase text-[10px]">{renderTxnTypeLabel(item.ruleType)}</span>
                        <span className="font-semibold">{item.ruleName}</span>
                        {item.memo && <span className="text-indigo-600">{item.memo}</span>}
                      </div>
                      <span className="tabular-nums font-semibold">
                        {amountValue === null ? "ê¸ˆì•¡ ë¯¸ì •" : `${prefix}${amountValue.toLocaleString()}`}
                      </span>
                    </li>
                  );
                })}
              </ul>
            )}
          </section>
          <section>
            <h4 className="text-xs font-semibold uppercase text-gray-500">ë©”ëª¨ & ì´ë²¤íŠ¸</h4>
            {events.length === 0 ? (
              <p className="mt-1 text-xs text-gray-400">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            ) : (
              <ul className="mt-2 space-y-2">
                {events.map((event) => {
                  const tone = memberColorMap.get(event.user_id) || "#92400e";
                  const isEditing = editingEventId === event.id;
                  const isDeleting = deletingEventId === event.id;
                  return (
                    <li
                      key={event.id}
                      className={`rounded border px-3 py-2 text-xs shadow-sm transition ${
                        isEditing ? "ring-1" : ""
                      }`}
                      style={{
                        borderColor: `${tone}40`,
                        backgroundColor: `${tone}12`,
                        color: tone,
                        boxShadow: isEditing ? `0 0 0 1px ${tone}` : undefined,
                      }}
                    >
                      <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                        <div className="flex flex-wrap items-center gap-2">
                          <span className="inline-flex items-center gap-1 rounded-full px-1.5 py-0.5 text-[10px] font-medium" style={{ backgroundColor: `${tone}1A`, color: tone }}>
                            {memberInitial(event.user_id)}
                          </span>
                          <span className="inline-flex items-center gap-1 rounded bg-amber-100 px-1.5 py-0.5 font-medium uppercase text-[10px]">
                            {event.color && <span className="h-2.5 w-2.5 rounded-full" style={{ backgroundColor: event.color }} />}
                            {renderEventTypeLabel(event.type)}
                          </span>
                          <span className="font-semibold text-amber-900">{event.title}</span>
                          {event.description && <span className="text-amber-700">{event.description}</span>}
                        </div>
                        {(onEditEvent || onDeleteEvent) && (
                          <div className="flex flex-wrap items-center gap-1 text-[11px]">
                            {onEditEvent && (
                              <button
                                type="button"
                                onClick={() => onEditEvent(event)}
                                disabled={isDeleting}
                                className="rounded border border-amber-300 px-2 py-0.5 text-amber-700 hover:bg-amber-100 disabled:cursor-not-allowed disabled:opacity-60"
                              >
                                {isEditing ? "í¸ì§‘ ì¤‘" : "ìˆ˜ì •"}
                              </button>
                            )}
                            {onDeleteEvent && (
                              <button
                                type="button"
                                onClick={() => onDeleteEvent(event)}
                                disabled={isDeleting}
                                className="rounded border border-amber-300 px-2 py-0.5 text-amber-700 hover:bg-amber-100 disabled:cursor-not-allowed disabled:opacity-60"
                              >
                                {isDeleting ? "ì‚­ì œ ì¤‘â€¦" : "ì‚­ì œ"}
                              </button>
                            )}
                          </div>
                        )}
                      </div>
                    </li>
                  );
                })}
              </ul>
            )}
          </section>
        </div>
      ) : (
        <p className="text-xs text-gray-400">ì„ íƒëœ ë‚ ì§œì—ëŠ” ê¸°ë¡ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      )}
    </SectionCard>
  );
}

type EventEditorProps = {
  mode: "create" | "edit";
  draft: EventFormState;
  onDraftChange: (patch: Partial<EventFormState>) => void;
  onSubmit: () => Promise<void> | void;
  submitting: boolean;
  onCancel: () => void;
  error: string | null;
  message: string | null;
};

function EventEditor({ mode, draft, onDraftChange, onSubmit, submitting, onCancel, error, message }: EventEditorProps) {
  const handleSubmit = async (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    await onSubmit();
  };

  const disableSubmit = submitting || draft.title.trim().length === 0 || draft.date.trim().length === 0;

  return (
    <SectionCard
      title={mode === "edit" ? "ì„ íƒí•œ ì¼ì • ìˆ˜ì •" : "ìƒˆ ì¼ì • ë“±ë¡"}
      description="ë©”ëª¨, ê¸°ë…ì¼, ë¦¬ë§ˆì¸ë”ë¥¼ ì¶”ê°€í•˜ì„¸ìš”."
      tone="muted"
      headerAction={
        mode === "edit" ? (
          <button
            type="button"
            onClick={onCancel}
            disabled={submitting}
            className="rounded border border-amber-300 px-2 py-1 text-xs text-amber-700 hover:bg-amber-100 disabled:cursor-not-allowed disabled:opacity-60"
          >
            ìƒˆ ë©”ëª¨
          </button>
        ) : undefined
      }
    >
      {error && <p className="rounded bg-white px-3 py-2 text-xs text-red-600">{error}</p>}
      {message && !error && <p className="rounded bg-white px-3 py-2 text-xs text-emerald-700">{message}</p>}
      <form className="space-y-3" onSubmit={handleSubmit}>
        <label className="flex flex-col gap-1">
          <span className="text-xs uppercase text-amber-600">ë‚ ì§œ</span>
          <input
            type="date"
            value={draft.date}
            onChange={(e) => onDraftChange({ date: e.target.value })}
            className="rounded border border-amber-200 bg-white px-2 py-1 text-sm text-amber-900 focus:border-amber-400 focus:outline-none"
            required
          />
        </label>
        <label className="flex flex-col gap-1">
          <span className="text-xs uppercase text-amber-600">ìœ í˜•</span>
          <select
            value={draft.type}
            onChange={(e) => onDraftChange({ type: e.target.value as CalendarEventType })}
            className="rounded border border-amber-200 bg-white px-2 py-1 text-sm text-amber-900 focus:border-amber-400 focus:outline-none"
          >
            {EVENT_TYPE_OPTIONS.map((option) => (
              <option key={option.value} value={option.value}>
                {option.label}
              </option>
            ))}
          </select>
        </label>
        <label className="flex flex-col gap-1">
          <span className="text-xs uppercase text-amber-600">ì œëª©</span>
          <input
            type="text"
            value={draft.title}
            onChange={(e) => onDraftChange({ title: e.target.value })}
            className="rounded border border-amber-200 bg-white px-2 py-1 text-sm text-amber-900 focus:border-amber-400 focus:outline-none"
            placeholder="ë©”ëª¨ ì œëª©"
            maxLength={200}
            required
          />
        </label>
        <label className="flex flex-col gap-1">
          <span className="text-xs uppercase text-amber-600">ì„¤ëª…</span>
          <textarea
            value={draft.description}
            onChange={(e) => onDraftChange({ description: e.target.value })}
            className="min-h-[60px] rounded border border-amber-200 bg-white px-2 py-1 text-sm text-amber-900 focus:border-amber-400 focus:outline-none"
            placeholder="ì„¸ë¶€ ë©”ëª¨ (ì„ íƒ)"
          />
        </label>
        <div className="flex flex-col gap-2">
          <span className="text-xs uppercase text-amber-600">ìƒ‰ìƒ</span>
          <div className="flex flex-wrap gap-2">
            {EVENT_COLOR_SWATCHES.map((hex) => {
              const isSelected = draft.color?.toLowerCase() === hex.toLowerCase();
              return (
                <button
                  key={hex}
                  type="button"
                  onClick={() => onDraftChange({ color: hex })}
                  className={`h-8 w-8 rounded-full border transition focus:outline-none focus:ring-2 focus:ring-amber-500 ${
                    isSelected ? "border-amber-700 ring-2 ring-amber-500" : "border-white shadow"
                  }`}
                  style={{ backgroundColor: hex }}
                  aria-label={`${hex} ìƒ‰ìƒ ì„ íƒ`}
                />
              );
            })}
            <label className="inline-flex h-8 w-8 cursor-pointer items-center justify-center rounded-full border border-amber-300 bg-white text-[10px] font-semibold text-amber-600 shadow">
              <span className="sr-only">ì‚¬ìš©ì ì§€ì • ìƒ‰ìƒ</span>
              ğŸ¨
              <input
                type="color"
                value={draft.color ? draft.color : "#facc15"}
                onChange={(e) => onDraftChange({ color: e.target.value })}
                className="hidden"
              />
            </label>
          </div>
          <div className="flex items-center gap-2">
            <input
              type="text"
              value={draft.color}
              onChange={(e) => onDraftChange({ color: e.target.value })}
              placeholder="#facc15"
              pattern="^$|^#[0-9A-Fa-f]{6}([0-9A-Fa-f]{2})?$"
              className="flex-1 rounded border border-amber-200 bg-white px-2 py-1 text-sm text-amber-900 focus:border-amber-400 focus:outline-none"
            />
            <button
              type="button"
              onClick={() => onDraftChange({ color: "" })}
              className="rounded border border-amber-300 px-2 py-1 text-xs text-amber-700 hover:bg-amber-100"
            >
              ì´ˆê¸°í™”
            </button>
            {draft.color && (
              <span
                className="inline-flex h-6 w-6 rounded-full border border-amber-300"
                style={{ backgroundColor: draft.color }}
                aria-label="ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸°"
              />
            )}
          </div>
          <p className="text-[11px] text-amber-600">ê¸°ë³¸ íŒ”ë ˆíŠ¸ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ğŸ¨ ë²„íŠ¼ìœ¼ë¡œ ì‚¬ìš©ì ìƒ‰ì„ ê³ ë¥´ì„¸ìš”. ì§ì ‘ ì…ë ¥ ì‹œ #RRGGBB í˜¹ì€ #RRGGBBAA í˜•íƒœë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</p>
        </div>
        <div className="flex items-center justify-end gap-2 pt-2">
          {mode === "edit" && (
            <button
              type="button"
              onClick={onCancel}
              disabled={submitting}
              className="rounded border border-amber-300 px-3 py-1 text-xs text-amber-700 hover:bg-amber-100 disabled:cursor-not-allowed disabled:opacity-60"
            >
              ì·¨ì†Œ
            </button>
          )}
          <button
            type="submit"
            disabled={disableSubmit}
            className="rounded bg-amber-500 px-4 py-1 text-xs font-semibold text-white shadow hover:bg-amber-600 disabled:cursor-not-allowed disabled:opacity-60"
          >
            {submitting ? "ì €ì¥ ì¤‘â€¦" : mode === "edit" ? "ì¼ì • ì—…ë°ì´íŠ¸" : "ì¼ì • ì¶”ê°€"}
          </button>
        </div>
      </form>
    </SectionCard>
  );
}

function formatTransactionTime(txn: CalendarTransaction) {
  if (txn.occurred_time) return txn.occurred_time.slice(0, 5);
  const date = new Date(txn.occurred_at);
  if (!Number.isNaN(date.getTime())) return format(date, "HH:mm");
  return "ì¢…ì¼";
}

export function isRecurringTransaction(txn: CalendarTransaction): boolean {
  return extractRecurringRuleId(txn.external_id ?? null) !== null;
}

function renderTxnTypeLabel(type: CalendarTransaction["type"]) {
  switch (type) {
    case "INCOME":
      return "ìˆ˜ì…";
    case "EXPENSE":
      return "ì§€ì¶œ";
    default:
      return "ì´ì²´";
  }
}

function amountTone(txn: CalendarTransaction) {
  if (txn.amount > 0) return "text-emerald-600";
  if (txn.amount < 0) return "text-rose-600";
  return "text-gray-700";
}

function formatTxnAmount(txn: CalendarTransaction) {
  if (txn.amount > 0) {
    return `+${txn.amount.toLocaleString()}`;
  }
  if (txn.amount < 0) {
    return `-${Math.abs(txn.amount).toLocaleString()}`;
  }
  return "0";
}

function renderEventTypeLabel(type: CalendarEventType) {
  switch (type) {
    case "memo":
      return "ë©”ëª¨";
    case "anniversary":
      return "ê¸°ë…ì¼";
    case "reminder":
      return "ë¦¬ë§ˆì¸ë”";
    default:
      return "ì´ë²¤íŠ¸";
  }
}
